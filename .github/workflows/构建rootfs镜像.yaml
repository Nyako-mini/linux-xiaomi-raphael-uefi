# 统一的系统镜像构建工作流 - 在 Ubuntu 24.04 ARM 上运行
name: 构建系统镜像

# 手动触发，可指定所有参数
on:
  workflow_dispatch:
    inputs:
      system_type:
        description: '系统类型'
        required: true
        default: 'debian-desktop'
        type: choice
        options:
          - debian-desktop
          - debian-server
          - ubuntu-desktop
          - ubuntu-server
      kernel_version:
        description: '内核版本号 (从 Release 下载对应版本)'
        required: true
        default: '6.18'
      desktop_environment:
        description: '桌面环境 (仅适用于Desktop版本)'
        required: false
        default: ''
        type: choice
        options:
          - ''
          - phosh-core
          - phosh-full
          - phosh-phone
          - kde-plasma     # KDE Plasma 桌面
          - kde-full       # KDE Plasma 完整版
          - kde-minimal    # KDE Plasma 最小化版
          - gnome-core     # GNOME 核心版
          - gnome-full     # GNOME 完整版
          - gnome-minimal  # GNOME 最小化版

# 工作流配置
jobs:
  build-system-image:
    # 在 Ubuntu 24.04 ARM 上运行
    runs-on: ubuntu-24.04-arm
    
    # 设置权限，允许创建 Release
    permissions:
      contents: write   # 允许创建 Release 和上传文件
      packages: write   # 允许上传包（如果需要）
    
    # 定义环境变量
    env:
      BUILD_TIMESTAMP: ${{ format('{0}', github.run_id) }}-${{ github.run_number }}
      SYSTEM_TYPE: ${{ inputs.system_type }}
      KERNEL_VERSION: ${{ inputs.kernel_version }}
      DESKTOP_ENV: ${{ inputs.desktop_environment || 'phosh-full' }}
    
    steps:
      # 检出代码
      - name: 检出代码
        uses: actions/checkout@v4
    
      # 安装debootstrap和7z
      - name: 安装构建工具
        run: |
          sudo apt update
          sudo apt install -y debootstrap p7zip-full
      
      # 验证参数
      - name: 验证构建参数
        run: |
          echo "构建配置:"
          echo "系统类型: ${{ env.SYSTEM_TYPE }}"
          echo "内核版本: ${{ env.KERNEL_VERSION }}"
          echo "桌面环境: ${{ env.DESKTOP_ENV }}"
          
          # 检查Desktop版本是否提供了桌面环境参数
          if [[ "${{ env.SYSTEM_TYPE }}" == *"desktop"* && -z "${{ inputs.desktop_environment }}" ]]; then
            echo "错误: Desktop版本必须指定桌面环境参数"
            exit 1
          fi
          
          # 验证桌面环境选项的有效性
          if [[ "${{ env.SYSTEM_TYPE }}" == *"desktop"* ]]; then
            DESKTOP_TYPE="${{ env.DESKTOP_ENV }}"
            if [[ ! "$DESKTOP_TYPE" =~ ^(phosh-core|phosh-full|phosh-phone|kde-plasma|kde-full|kde-minimal|gnome-core|gnome-full|gnome-minimal)$ ]]; then
              echo "错误: 无效的桌面环境选项: $DESKTOP_TYPE"
              exit 1
            fi
          fi
      
      # 从 GitHub Release 下载内核包
      - name: 下载内核编译产物
        id: download-kernel
        run: |
          # 从 Release 下载指定版本的内核包
          mkdir -p xiaomi-raphael-debs_${{ env.KERNEL_VERSION }}
          
          echo "正在下载内核包 (版本: ${{ env.KERNEL_VERSION }})..."
          
          # 下载通用内核包
          curl -L -o xiaomi-raphael-debs_${{ env.KERNEL_VERSION }}/linux-image-xiaomi-raphael.deb \
            "https://github.com/${{ github.repository }}/releases/download/kernel-v${{ env.KERNEL_VERSION }}/linux-image-xiaomi-raphael.deb" || echo "下载 linux-image-xiaomi-raphael.deb 失败，可能 Release 不存在"
          
          curl -L -o xiaomi-raphael-debs_${{ env.KERNEL_VERSION }}/linux-headers-xiaomi-raphael.deb \
            "https://github.com/${{ github.repository }}/releases/download/kernel-v${{ env.KERNEL_VERSION }}/linux-headers-xiaomi-raphael.deb" || echo "下载 linux-headers-xiaomi-raphael.deb 失败，可能 Release 不存在"
          
          curl -L -o xiaomi-raphael-debs_${{ env.KERNEL_VERSION }}/firmware-xiaomi-raphael.deb \
            "https://github.com/${{ github.repository }}/releases/download/kernel-v${{ env.KERNEL_VERSION }}/firmware-xiaomi-raphael.deb" || echo "下载 firmware-xiaomi-raphael.deb 失败，可能 Release 不存在"
          
          # 下载设备树文件 dtb
          curl -L -o xiaomi-raphael-debs_${{ env.KERNEL_VERSION }}/sm8150-xiaomi-raphael.dtb \
            "https://github.com/${{ github.repository }}/releases/download/kernel-v${{ env.KERNEL_VERSION }}/sm8150-xiaomi-raphael.dtb" || echo "下载 sm8150-xiaomi-raphael.dtb 失败，可能 Release 不存在"
          
          # Desktop版本需要额外的alsa包
          if [[ "${{ env.SYSTEM_TYPE }}" == *"desktop"* ]]; then
            curl -L -o xiaomi-raphael-debs_${{ env.KERNEL_VERSION }}/alsa-xiaomi-raphael.deb \
              "https://github.com/${{ github.repository }}/releases/download/kernel-v${{ env.KERNEL_VERSION }}/alsa-xiaomi-raphael.deb" || echo "下载 alsa-xiaomi-raphael.deb 失败，可能 Release 不存在"
          fi
          
          # 下载额外的桌面环境依赖包
          DESKTOP_TYPE="${{ env.DESKTOP_ENV }}"
          if [[ "$DESKTOP_TYPE" == *"kde"* ]]; then
            curl -L -o xiaomi-raphael-debs_${{ env.KERNEL_VERSION }}/kde-support-xiaomi-raphael.deb \
              "https://github.com/${{ github.repository }}/releases/download/kernel-v${{ env.KERNEL_VERSION }}/kde-support-xiaomi-raphael.deb" || echo "下载 kde-support-xiaomi-raphael.deb 失败"
          fi
          
          if [[ "$DESKTOP_TYPE" == *"gnome"* ]]; then
            curl -L -o xiaomi-raphael-debs_${{ env.KERNEL_VERSION }}/gnome-support-xiaomi-raphael.deb \
              "https://github.com/${{ github.repository }}/releases/download/kernel-v${{ env.KERNEL_VERSION }}/gnome-support-xiaomi-raphael.deb" || echo "下载 gnome-support-xiaomi-raphael.deb 失败"
          fi
          
          # 检查是否下载成功
          echo "下载的内核包列表:"
          ls -la xiaomi-raphael-debs_${{ env.KERNEL_VERSION }}/ || echo "目录为空"
          
          # 检查必要文件是否存在
          if [ ! -f "xiaomi-raphael-debs_${{ env.KERNEL_VERSION }}/linux-image-xiaomi-raphael.deb" ]; then
            echo "错误: 必要的内核包未下载成功"
            exit 1
          fi
          
          # 提取内核包中的实际内核版本
          KERNEL_PKG_VERSION=$(dpkg-deb -f xiaomi-raphael-debs_${{ env.KERNEL_VERSION }}/linux-image-xiaomi-raphael.deb Package | sed 's/linux-image-//')
          echo "提取的内核包版本: $KERNEL_PKG_VERSION"
          echo "kernel_pkg_version=$KERNEL_PKG_VERSION" >> $GITHUB_OUTPUT
      
      # 根据系统类型选择构建脚本
      - name: 构建系统镜像
        id: build-image
        run: |
          echo "开始构建 ${{ env.SYSTEM_TYPE }} 镜像..."
          echo "桌面环境: ${{ env.DESKTOP_ENV }}"
          
          # 根据系统类型执行对应的构建脚本
          case "${{ env.SYSTEM_TYPE }}" in
            "debian-desktop")
              sudo sh debian-desktop_build.sh "${{ env.DESKTOP_ENV }}" "${{ env.KERNEL_VERSION }}"
              ;;
            "debian-server")
              sudo sh debian-server_build.sh "${{ env.KERNEL_VERSION }}"
              ;;
            "ubuntu-desktop")
              sudo sh ubuntu-desktop_build.sh "${{ env.DESKTOP_ENV }}" "${{ env.KERNEL_VERSION }}"
              ;;
            "ubuntu-server")
              sudo sh ubuntu-server_build.sh "${{ env.KERNEL_VERSION }}"
              ;;
            *)
              echo "错误: 未知的系统类型: ${{ env.SYSTEM_TYPE }}"
              exit 1
              ;;
          esac
          
          echo "镜像构建完成!"
          
          # 获取rootfs.img的UUID
          if [ -f "rootfs.img" ]; then
            ROOTFS_UUID=$(sudo blkid -s UUID -o value rootfs.img)
            echo "rootfs.img UUID: $ROOTFS_UUID"
            echo "rootfs_uuid=$ROOTFS_UUID" >> $GITHUB_OUTPUT
          else
            echo "警告: rootfs.img 文件不存在"
            echo "rootfs_uuid=未知" >> $GITHUB_OUTPUT
          fi
          
          # 压缩rootfs.img为7z格式
          if [ -f "rootfs.img" ]; then
            echo "正在压缩rootfs.img为7z格式..."
            7z a -mx=9 rootfs.7z rootfs.img
            echo "压缩完成: $(ls -lh rootfs.7z)"
          fi
      
      # 获取构建信息
      - name: 获取构建信息
        id: build-info
        run: |
          # 获取时间戳
          TIMESTAMP=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          
          # 获取系统版本信息
          case "${{ env.SYSTEM_TYPE }}" in
            "debian-desktop"|"debian-server")
              OS_NAME="Debian"
              OS_VERSION="trixie"
              ;;
            "ubuntu-desktop"|"ubuntu-server")
              OS_NAME="Ubuntu"
              OS_VERSION="noble"
              ;;
          esac
          echo "os_name=$OS_NAME" >> $GITHUB_OUTPUT
          echo "os_version=$OS_VERSION" >> $GITHUB_OUTPUT
          
          # 确定系统类别
          if [[ "${{ env.SYSTEM_TYPE }}" == *"desktop"* ]]; then
            SYSTEM_CATEGORY="Desktop"
          else
            SYSTEM_CATEGORY="Server"
          fi
          echo "system_category=$SYSTEM_CATEGORY" >> $GITHUB_OUTPUT
          
          # 获取桌面环境友好名称
          DESKTOP_TYPE="${{ env.DESKTOP_ENV }}"
          case "$DESKTOP_TYPE" in
            "phosh-core")
              DESKTOP_FRIENDLY="Phosh Core"
              ;;
            "phosh-full")
              DESKTOP_FRIENDLY="Phosh Full"
              ;;
            "phosh-phone")
              DESKTOP_FRIENDLY="Phosh Phone"
              ;;
            "kde-plasma")
              DESKTOP_FRIENDLY="KDE Plasma"
              ;;
            "kde-full")
              DESKTOP_FRIENDLY="KDE Full"
              ;;
            "kde-minimal")
              DESKTOP_FRIENDLY="KDE Minimal"
              ;;
            "gnome-core")
              DESKTOP_FRIENDLY="GNOME Core"
              ;;
            "gnome-full")
              DESKTOP_FRIENDLY="GNOME Full"
              ;;
            "gnome-minimal")
              DESKTOP_FRIENDLY="GNOME Minimal"
              ;;
            *)
              DESKTOP_FRIENDLY="$DESKTOP_TYPE"
              ;;
          esac
          echo "desktop_friendly=$DESKTOP_FRIENDLY" >> $GITHUB_OUTPUT
      
      # 生成Release标签和名称
      - name: 生成Release信息
        id: release-info
        run: |
          # 生成Release标签
          TAG="${{ env.SYSTEM_TYPE }}-v${{ env.KERNEL_VERSION }}"
          if [[ "${{ env.SYSTEM_TYPE }}" == *"desktop"* ]]; then
            TAG="${TAG}-${{ env.DESKTOP_ENV }}"
          fi
          echo "tag_name=$TAG" >> $GITHUB_OUTPUT
          
          # 生成Release名称
          RELEASE_NAME="${{ steps.build-info.outputs.os_name }} ${{ steps.build-info.outputs.system_category }} 镜像 v${{ env.KERNEL_VERSION }}"
          if [[ "${{ env.SYSTEM_TYPE }}" == *"desktop"* ]]; then
            RELEASE_NAME="${RELEASE_NAME} (${{ steps.build-info.outputs.desktop_friendly }})"
          fi
          echo "release_name=$RELEASE_NAME" >> $GITHUB_OUTPUT
      
      # 生成Release描述
      - name: 生成Release描述
        id: release-desc
        run: |
          # 构建描述内容
          DESCRIPTION="## 小米 Raphael 设备 ${{ steps.build-info.outputs.os_name }} ${{ steps.build-info.outputs.system_category }} 镜像\n\n"
          DESCRIPTION="${DESCRIPTION}### 系统信息\n"
          DESCRIPTION="${DESCRIPTION}- 系统版本: ${{ steps.build-info.outputs.os_name }} ${{ steps.build-info.outputs.os_version }}\n"
          DESCRIPTION="${DESCRIPTION}- 内核版本: ${{ steps.download-kernel.outputs.kernel_pkg_version }}\n"
          DESCRIPTION="${DESCRIPTION}- 系统镜像UUID: ${{ steps.build-image.outputs.rootfs_uuid }}\n"
          
          if [[ "${{ env.SYSTEM_TYPE }}" == *"desktop"* ]]; then
            DESCRIPTION="${DESCRIPTION}- 桌面环境: ${{ steps.build-info.outputs.desktop_friendly }}\n"
          fi
          
          DESCRIPTION="${DESCRIPTION}- 构建时间: ${{ steps.build-info.outputs.timestamp }}\n"
          DESCRIPTION="${DESCRIPTION}- 构建 ID: ${{ env.BUILD_TIMESTAMP }}\n\n"
          
          # 添加特定说明
          if [[ "${{ env.SYSTEM_TYPE }}" == *"server"* ]]; then
            DESCRIPTION="${DESCRIPTION}### 特性说明\n"
            DESCRIPTION="${DESCRIPTION}- ✅ 这是一个无图形界面的服务器版本\n"
            DESCRIPTION="${DESCRIPTION}- ✅ 包含基础网络管理工具\n"
            DESCRIPTION="${DESCRIPTION}- ✅ 已安装 SSH 服务器\n"
            DESCRIPTION="${DESCRIPTION}- ✅ 已安装中文语言支持\n"
            DESCRIPTION="${DESCRIPTION}- ✅ 包含必要的设备驱动和固件\n"
          else
            DESCRIPTION="${DESCRIPTION}### 特性说明\n"
            DESCRIPTION="${DESCRIPTION}- ✅ 这是一个带有图形界面的桌面版本\n"
            DESCRIPTION="${DESCRIPTION}- ✅ 包含 ${{ steps.build-info.outputs.desktop_friendly }} 桌面环境\n"
            DESCRIPTION="${DESCRIPTION}- ✅ 已安装 SSH 服务器\n"
            DESCRIPTION="${DESCRIPTION}- ✅ 已安装中文语言支持\n"
            DESCRIPTION="${DESCRIPTION}- ✅ 包含必要的设备驱动和固件\n"
            
            # 根据桌面环境添加特定说明
            DESKTOP_TYPE="${{ env.DESKTOP_ENV }}"
            if [[ "$DESKTOP_TYPE" == *"kde"* ]]; then
              DESCRIPTION="${DESCRIPTION}- ✅ 针对 KDE Plasma 进行了优化配置\n"
              DESCRIPTION="${DESCRIPTION}- ✅ 包含 KDE 应用套件\n"
            elif [[ "$DESKTOP_TYPE" == *"gnome"* ]]; then
              DESCRIPTION="${DESCRIPTION}- ✅ 针对 GNOME 进行了优化配置\n"
              DESCRIPTION="${DESCRIPTION}- ✅ 包含 GNOME 应用套件\n"
            elif [[ "$DESKTOP_TYPE" == *"phosh"* ]]; then
              DESCRIPTION="${DESCRIPTION}- ✅ 针对手机使用进行了优化\n"
              DESCRIPTION="${DESCRIPTION}- ✅ 包含 Phosh 手机界面组件\n"
            fi
          fi
          
          DESCRIPTION="${DESCRIPTION}\n### 安装说明\n"
          DESCRIPTION="${DESCRIPTION}1. 下载 rootfs.7z 文件\n"
          DESCRIPTION="${DESCRIPTION}2. 解压得到 rootfs.img: \`7z x rootfs.7z\`\n"
          DESCRIPTION="${DESCRIPTION}3. 将 rootfs.img 写入到设备分区\n"
          DESCRIPTION="${DESCRIPTION}4. 确保设备树文件正确放置\n"
          DESCRIPTION="${DESCRIPTION}5. 首次启动建议进入恢复模式进行初始配置\n"
          
          echo "description<<EOF" >> $GITHUB_OUTPUT
          echo -e "$DESCRIPTION" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      # 创建 GitHub Release 并上传镜像
      - name: 创建 Release 并上传镜像
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.release-info.outputs.tag_name }}
          name: ${{ steps.release-info.outputs.release_name }}
          body: ${{ steps.release-desc.outputs.description }}
          draft: false
          prerelease: false
          files: |
            rootfs.7z
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # 上传镜像作为工作流制品
      - name: 上传镜像作为工作流制品
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.SYSTEM_TYPE }}-${{ env.DESKTOP_ENV }}-image-v${{ env.KERNEL_VERSION }}
          path: |
            rootfs.7z
          retention-days: 30
      
      # 清理临时文件
      - name: 清理临时文件
        if: always()
        run: |
          echo "清理临时文件..."
          sudo rm -f rootfs.img rootfs.7z 2>/dev/null || true
          sudo rm -rf rootdir 2>/dev/null || true
          rm -rf xiaomi-raphael-debs_* 2>/dev/null || true
